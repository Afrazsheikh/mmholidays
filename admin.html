<!DOCTYPE html>
<html>
  <head>
    <title>Admin Panel - Manage Packages</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.ckeditor.com/ckeditor5/40.2.0/classic/ckeditor.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f2f2f2;
        margin: 0;
        padding: 10px;
      }
      .card {
        background: #fff;
        border-radius: 10px;
        max-width: 900px;
        margin: 10px auto;
        padding: 15px;
        box-shadow: 0 0 10px #bbb;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
      }
      button {
        padding: 12px;
        width: 100%;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px 0;
      }
      button:hover {
        background: #0056d2;
      }
      button.delete-btn {
        background: #dc3545;
      }
      button.delete-btn:hover {
        background: #a71d2a;
      }
      label {
        font-weight: bold;
      }
      #previewImage {
        max-width: 100px;
        max-height: 100px;
        margin-top: 10px;
        display: block;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      #loader {
        display: none;
        border: 6px solid #f3f3f3;
        border-top: 6px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 10px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .bottom-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }
      .bottom-buttons button {
        flex: 1;
      }
      @media (max-width: 500px) {
        .card {
          width: 95%;
          padding: 10px;
        }
      }
      .ck-editor__editable {
        min-height: 200px;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h2>Admin Panel â€“ Manage Packages</h2>

      <label>GitHub Token:</label>
      <input type="password" id="token" placeholder="Enter GitHub Token" />

      <label>Select Package:</label>
      <select id="packageSelect" onchange="loadSelectedPackage()"></select>

      <label>Package Name:</label>
      <input type="text" id="name" />

      <label>Price:</label>
      <input type="number" id="price" />

      <label>Offer Price:</label>
      <input type="number" id="offerPrice" />

      <label>Duration:</label>
      <input type="text" id="duration" />

      <label>Package Image:</label>
      <input type="file" id="packageImage" accept="image/*" />
      <img id="previewImage" src="" alt="Preview" />
      <div id="loader"></div>

      <label>Description (HTML):</label>
      <textarea id="desc"></textarea>

      <button onclick="saveJSON()">ðŸ’¾ Save Changes</button>
      <p id="output" style="color: green; font-weight: bold"></p>

      <div class="bottom-buttons">
        <button onclick="addNewPackage()">âž• Add New</button>
        <button onclick="deletePackage()" class="delete-btn">ðŸ—‘ Delete</button>
      </div>
    </div>

    <script>
      const repoOwner = "Afrazsheikh";
      const repoName = "mmholidays";
      const filePath = "packages.json";

      let allPackages = [];
      let selectedIndex = 0;
      let descEditor;

      // CKEditor full toolbar with color picker
      ClassicEditor.create(document.querySelector("#desc"), {
        toolbar: [
          "heading",
          "|",
          "bold",
          "italic",
          "underline",
          "strikethrough",
          "link",
          "|",
          "fontSize",
          "fontColor",
          "fontBackgroundColor",
          "fontFamily",
          "|",
          "bulletedList",
          "numberedList",
          "alignment",
          "|",
          "outdent",
          "indent",
          "|",
          "undo",
          "redo",
        ],
        fontColor: {
          colors: [
            { color: "#000000", label: "Black" },
            { color: "#FFFFFF", label: "White" },
            { color: "#FF0000", label: "Red" },
            { color: "#00FF00", label: "Lime" },
            { color: "#0000FF", label: "Blue" },
            { color: "#FFFF00", label: "Yellow" },
            { color: "#FFA500", label: "Orange" },
            { color: "#800080", label: "Purple" },
            { color: "#00FFFF", label: "Aqua" },
            { color: "#FFC0CB", label: "Pink" },
          ],
          columns: 5,
        },
        fontBackgroundColor: {
          colors: [
            { color: "#000000", label: "Black" },
            { color: "#FFFFFF", label: "White" },
            { color: "#FF0000", label: "Red" },
            { color: "#00FF00", label: "Lime" },
            { color: "#0000FF", label: "Blue" },
            { color: "#FFFF00", label: "Yellow" },
            { color: "#FFA500", label: "Orange" },
            { color: "#800080", label: "Purple" },
            { color: "#00FFFF", label: "Aqua" },
            { color: "#FFC0CB", label: "Pink" },
          ],
          columns: 5,
        },
      })
        .then((editor) => {
          descEditor = editor;
        })
        .catch((err) => console.error(err));

      async function loadData() {
        const res = await fetch(
          `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/${filePath}`
        );
        const data = await res.json();
        allPackages = data.packages;

        const select = document.getElementById("packageSelect");
        select.innerHTML = "";
        allPackages.forEach((pkg, index) => {
          const opt = document.createElement("option");
          opt.value = index;
          opt.textContent = pkg.name;
          select.appendChild(opt);
        });
        loadSelectedPackage();
      }

      function loadSelectedPackage() {
        if (allPackages.length === 0) return;
        selectedIndex = document.getElementById("packageSelect").value;
        const pkg = allPackages[selectedIndex];
        document.getElementById("name").value = pkg.name;
        document.getElementById("price").value = pkg.price;
        document.getElementById("offerPrice").value = pkg.offerPrice;
        document.getElementById("duration").value = pkg.duration;
        descEditor.setData(pkg.desc || "");
        document.getElementById("previewImage").src = pkg.imageUrl
          ? `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/images/${pkg.imageUrl}`
          : "";
      }

      function addNewPackage() {
        const newPkg = {
          id: Date.now().toString(),
          name: "New Package",
          price: 0,
          offerPrice: 0,
          duration: "",
          imageUrl: "",
          desc: "",
        };
        allPackages.push(newPkg);
        selectedIndex = allPackages.length - 1;
        const select = document.getElementById("packageSelect");
        const opt = document.createElement("option");
        opt.value = selectedIndex;
        opt.textContent = "âž• New Package";
        select.appendChild(opt);
        select.value = selectedIndex;
        loadSelectedPackage();
      }

      function deletePackage() {
        if (allPackages.length === 0) return;
        if (confirm("Are you sure you want to delete this package?")) {
          allPackages.splice(selectedIndex, 1);
          const select = document.getElementById("packageSelect");
          select.remove(selectedIndex);
          selectedIndex = 0;
          if (allPackages.length > 0) select.value = 0;
          loadSelectedPackage();
        }
      }

      async function uploadImage() {
        const token = document.getElementById("token").value;
        const fileInput = document.getElementById("packageImage");
        if (!fileInput.files[0]) return allPackages[selectedIndex]?.imageUrl;
        const file = fileInput.files[0];
        const loader = document.getElementById("loader");
        loader.style.display = "block";
        const path = `images/${file.name}`;
        let sha = null;
        try {
          const res = await fetch(
            `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`
          );
          const data = await res.json();
          if (data.sha) sha = data.sha;
        } catch (err) {}
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = async function (e) {
            const content = e.target.result.split(",")[1];
            const upload = await fetch(
              `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({
                  message: "Upload package image via admin panel",
                  content,
                  sha,
                }),
              }
            );
            loader.style.display = "none";
            if (upload.ok) resolve(file.name);
            else {
              alert("Image upload failed!");
              resolve(allPackages[selectedIndex]?.imageUrl);
            }
          };
          reader.readAsDataURL(file);
        });
      }

      async function saveJSON() {
        const token = document.getElementById("token").value;
        if (!token) return alert("GitHub Token is required!");
        const uploadedImageName = await uploadImage();
        const pkg = allPackages[selectedIndex];
        pkg.name = document.getElementById("name").value;
        pkg.price = Number(document.getElementById("price").value);
        pkg.offerPrice = Number(document.getElementById("offerPrice").value);
        pkg.duration = document.getElementById("duration").value;
        pkg.desc = descEditor.getData();
        pkg.imageUrl = uploadedImageName;

        const newJson = { packages: allPackages };
        const fileInfo = await fetch(
          `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`
        );
        const fileData = await fileInfo.json();

        function utf8ToBase64(str) {
          return btoa(unescape(encodeURIComponent(str)));
        }

        const upload = await fetch(
          `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`,
          {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              message: "Admin panel update",
              content: utf8ToBase64(JSON.stringify(newJson, null, 2)),
              sha: fileData.sha,
            }),
          }
        );

        document.getElementById("output").innerText = upload.ok
          ? "Updated Successfully!"
          : "Update FAILED!";
      }

      document
        .getElementById("packageImage")
        .addEventListener("change", function () {
          const file = this.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              document.getElementById("previewImage").src = e.target.result;
            };
            reader.readAsDataURL(file);
          }
        });

      loadData();
    </script>
  </body>
</html>
