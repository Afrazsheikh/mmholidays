<!DOCTYPE html>
<html>
  <head>
    <title>Admin Panel - Manage Packages</title>
    <style>
      body {
        font-family: Arial;
        padding: 20px;
        background: #f2f2f2;
      }
      .card {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        width: 700px;
        margin: auto;
        box-shadow: 0 0 10px #bbb;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 6px;
      }
      button {
        padding: 12px;
        width: 100%;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
      }
      button:hover {
        background: #0056d2;
      }
      label {
        font-weight: bold;
      }
      #previewImage {
        max-width: 200px;
        margin-top: 10px;
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h2>Admin Panel â€“ Manage Packages</h2>

      <label>GitHub Token:</label>
      <input type="password" id="token" placeholder="Enter GitHub Token" />

      <label>Select Package:</label>
      <select id="packageSelect" onchange="loadSelectedPackage()"></select>

      <button onclick="addNewPackage()">âž• Add New Package</button>
      <button onclick="deletePackage()" style="background: #dc3545">
        ðŸ—‘ Delete Package
      </button>

      <label>Package Name:</label>
      <input type="text" id="name" />

      <label>Price:</label>
      <input type="number" id="price" />

      <label>Offer Price:</label>
      <input type="number" id="offerPrice" />

      <label>Duration:</label>
      <input type="text" id="duration" />

      <label>Package Image:</label>
      <input type="file" id="packageImage" accept="image/*" />
      <img id="previewImage" src="" alt="Preview" />

      <label>Description (HTML):</label>
      <textarea id="desc" rows="8"></textarea>

      <button onclick="saveJSON()">ðŸ’¾ Save Changes</button>
      <p id="output" style="color: green; font-weight: bold"></p>
    </div>

    <script>
      const repoOwner = "Afrazsheikh";
      const repoName = "mmholidays";
      const filePath = "packages.json";

      let allPackages = [];
      let selectedIndex = 0;

      // Load packages.json from GitHub
      async function loadData() {
        const res = await fetch(
          `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/${filePath}`
        );
        const data = await res.json();
        allPackages = data.packages;

        const select = document.getElementById("packageSelect");
        select.innerHTML = "";

        allPackages.forEach((pkg, index) => {
          const opt = document.createElement("option");
          opt.value = index;
          opt.textContent = pkg.name;
          select.appendChild(opt);
        });

        loadSelectedPackage();
      }

      // Load selected package into fields
      function loadSelectedPackage() {
        selectedIndex = document.getElementById("packageSelect").value;
        const pkg = allPackages[selectedIndex];

        document.getElementById("name").value = pkg.name;
        document.getElementById("price").value = pkg.price;
        document.getElementById("offerPrice").value = pkg.offerPrice;
        document.getElementById("duration").value = pkg.duration;
        document.getElementById("desc").value = pkg.desc;
        document.getElementById("previewImage").src = pkg.imageUrl
          ? `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/images/${pkg.imageUrl}`
          : "";
      }

      // Add new package
      function addNewPackage() {
        const newPkg = {
          id: Date.now().toString(),
          name: "New Package",
          price: 0,
          offerPrice: 0,
          duration: "",
          imageUrl: "",
          desc: "",
        };

        allPackages.push(newPkg);
        selectedIndex = allPackages.length - 1;

        const select = document.getElementById("packageSelect");
        const opt = document.createElement("option");
        opt.value = selectedIndex;
        opt.textContent = "âž• New Package";
        select.appendChild(opt);
        select.value = selectedIndex;

        loadSelectedPackage();
      }

      // Delete selected package
      function deletePackage() {
        if (confirm("Are you sure you want to delete this package?")) {
          allPackages.splice(selectedIndex, 1);
          const select = document.getElementById("packageSelect");
          select.remove(selectedIndex);
          selectedIndex = 0;
          if (allPackages.length > 0) select.value = 0;
          loadSelectedPackage();
        }
      }

      // Upload image to GitHub
      async function uploadImage() {
        const token = document.getElementById("token").value;
        const fileInput = document.getElementById("packageImage");
        if (!fileInput.files[0]) return allPackages[selectedIndex].imageUrl;

        const file = fileInput.files[0];
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = async function (e) {
            const content = e.target.result.split(",")[1];
            const path = `images/${file.name}`;

            let sha = null;
            try {
              const res = await fetch(
                `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`
              );
              const data = await res.json();
              if (data.sha) sha = data.sha;
            } catch (err) {}

            const upload = await fetch(
              `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({
                  message: "Upload package image via admin panel",
                  content: content,
                  sha: sha,
                }),
              }
            );

            if (upload.ok) {
              alert("Image uploaded successfully!");
              resolve(file.name);
            } else {
              alert("Image upload failed!");
              resolve(allPackages[selectedIndex].imageUrl);
            }
          };
          reader.readAsDataURL(file);
        });
      }

      // Save updated JSON back to GitHub
      async function saveJSON() {
        const token = document.getElementById("token").value;
        if (!token) return alert("Token is required!");

        const uploadedImageName = await uploadImage();

        const pkg = allPackages[selectedIndex];
        pkg.name = document.getElementById("name").value;
        pkg.price = Number(document.getElementById("price").value);
        pkg.offerPrice = Number(document.getElementById("offerPrice").value);
        pkg.duration = document.getElementById("duration").value;
        pkg.desc = document.getElementById("desc").value;
        pkg.imageUrl = uploadedImageName;

        const newJson = { packages: allPackages };

        const fileInfo = await fetch(
          `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`
        );
        const fileData = await fileInfo.json();

        function utf8ToBase64(str) {
          return btoa(unescape(encodeURIComponent(str)));
        }

        const upload = await fetch(
          `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`,
          {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              message: "Admin panel update",
              content: utf8ToBase64(JSON.stringify(newJson, null, 2)),
              sha: fileData.sha,
            }),
          }
        );

        document.getElementById("output").innerText = upload.ok
          ? "Updated Successfully!"
          : "Update FAILED!";
      }

      // Preview selected image
      document
        .getElementById("packageImage")
        .addEventListener("change", function () {
          const file = this.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              document.getElementById("previewImage").src = e.target.result;
            };
            reader.readAsDataURL(file);
          }
        });

      loadData();
    </script>
  </body>
</html>
